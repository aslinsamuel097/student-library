<div class="book-list">
    <h3 style="font-size: 16px; color: #64748b;">AVAILABLE RESOURCES</h3>
    
    <div class="book-item">
        <div style="flex-grow: 1;">
            <b>Science Textbook</b><br>
            <small id="status-science">Preview Available (25 Pages)</small>
        </div>
        <div class="actions">
            <button onclick="readLimited('public/science_book.pdf')" class="btn-action">Read Online</button>
            <button onclick="borrowBook('Science Textbook', 'public/science_book.pdf')" class="btn-action" style="background: #f1f5f9; color: #1e293b; margin-left: 5px;">Borrow</button>
        </div>
    </div>
</div>

<div id="borrowed-section" style="margin-top: 30px; background: #fff; padding: 20px; border-radius: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.02);">
    <h3 style="font-size: 16px; color: var(--purple);">MY BORROWED BOOKS</h3>
    <div id="borrowed-list">
        <p style="color: #94a3b8; font-size: 14px;">No books borrowed yet.</p>
    </div>
</div>

<script>
    // 1. Limitation: Read Online (25 Pages)
    function readLimited(fileUrl) {
        alert("PREVIEW MODE: You can only view the first 25 pages. To see the full book, please use the 'Borrow' option.");
        // We add #page=1 to start at page 1, but browsers cannot strictly block page 26+ 
        // without a heavy PDF viewer. This warns the student.
        window.open(fileUrl + "#page=1", "_blank");
    }

    // 2. Borrow Logic (5 Day Limit)
    async function borrowBook(bookTitle, fileUrl) {
        const user = auth.currentUser;
        const borrowCode = prompt("Enter Borrowing Code for " + bookTitle + ":");
        
        // You can change these codes
        const validCodes = ["BORROW2026", "STUDENT101"];

        if (validCodes.includes(borrowCode)) {
            const borrowDate = new Date();
            const expiryDate = new Date();
            expiryDate.setDate(borrowDate.getDate() + 5);

            const borrowData = {
                title: bookTitle,
                url: fileUrl,
                userId: user.uid,
                borrowedOn: borrowDate.toISOString(),
                expiresOn: expiryDate.toISOString()
            };

            await db.collection("borrows").add(borrowData);
            alert(bookTitle + " added to your Borrowed tab for 5 days!");
            location.reload(); // Refresh to show in Borrowed tab
        } else {
            alert("Invalid Code. Contact Admin.");
        }
    }

    // 3. Load Borrowed Books & Calculate Fees
    async function loadBorrowedBooks() {
        const user = auth.currentUser;
        if (!user) return;

        const snapshot = await db.collection("borrows").where("userId", "==", user.uid).get();
        const container = document.getElementById('borrowed-list');
        
        if (snapshot.empty) return;
        container.innerHTML = "";

        snapshot.forEach(doc => {
            const data = doc.data();
            const now = new Date();
            const expiry = new Date(data.expiresOn);
            
            // Calculate Late Fees
            let feeMessage = "Status: Active";
            let diffDays = Math.ceil((now - expiry) / (1000 * 60 * 60 * 24));

            if (diffDays > 0) {
                if (diffDays === 1) feeMessage = "Late: 1 Day (Free Extension)";
                else if (diffDays <= 4) feeMessage = "Late Fee: ₹20";
                else if (diffDays <= 7) feeMessage = "Late Fee: ₹50";
                else {
                    feeMessage = "Expired - Please re-borrow";
                    // Logic to auto-remove from UI if too late
                    return; 
                }
            }

            container.innerHTML += `
                <div class="book-item" style="border-left: 4px solid var(--purple);">
                    <div style="flex-grow: 1;">
                        <b>${data.title} (FULL ACCESS)</b><br>
                        <small style="color: #ef4444;">${feeMessage}</small>
                    </div>
                    <a href="${data.url}" download class="btn-action" style="background: var(--purple); color: white;">Download PDF</a>
                </div>
            `;
        });
    }

    // Call this inside your auth listener
    auth.onAuthStateChanged((user) => {
        if (user) { loadBorrowedBooks(); }
    });
</script>
