<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Library Admin Control - Auto-Rotate</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root { --blue: #3b82f6; --purple: #a855f7; --bg: #f8fafc; }
        body { font-family: 'Poppins', sans-serif; background: var(--bg); padding: 20px; }
        .card { background: white; border-radius: 20px; padding: 25px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); margin-bottom: 25px; }
        table { width: 100%; border-collapse: collapse; }
        td { padding: 12px; border-bottom: 1px solid #eee; font-size: 13px; }
        .btn-sm { padding: 6px 12px; border-radius: 8px; border: none; font-size: 11px; cursor: pointer; font-weight: 600; margin: 2px; }
        .btn-add { background: #dcfce7; color: #166534; }
        .btn-rem { background: #fee2e2; color: #ef4444; }
        .btn-purp { background: #f3e8ff; color: #6b21a8; }
        #overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center; }
        .hidden { display: none !important; }
        .modal { background: white; width: 90%; max-width: 500px; border-radius: 20px; padding: 25px; }
    </style>
</head>
<body>

<div class="card">
    <h2 style="color:var(--blue); margin-top:0;">ðŸ“‚ Content Manager</h2>
    <p style="font-size:12px; color:#64748b;">Recent: Max 5 | Trending: Max 10 | Recommendations: Unlimited</p>
    <table>
        <thead><tr style="text-align:left; font-size:11px; color:#94a3b8;"><th>PDF NAME</th><th>CATEGORIES</th></tr></thead>
        <tbody>
            <tr>
                <td><b>Science Textbook</b></td>
                <td>
                    <button class="btn-sm btn-add" onclick="markAuto('science', 'recent', 5)">+ Recent</button>
                    <button class="btn-sm btn-add" onclick="markAuto('science', 'trending', 10)">+ Trending</button>
                    <button class="btn-sm btn-purp" onclick="openFacModal('science')">+ Recommend</button>
                    <br>
                    <button class="btn-sm btn-rem" onclick="unmark('science', 'recent')">Remove Recent</button>
                    <button class="btn-sm btn-rem" onclick="unmark('science', 'trending')">Remove Trending</button>
                </td>
            </tr>
            <tr>
                <td><b>Math Lesson Plan</b></td>
                <td>
                    <button class="btn-sm btn-add" onclick="markAuto('math', 'recent', 5)">+ Recent</button>
                    <button class="btn-sm btn-add" onclick="markAuto('math', 'trending', 10)">+ Trending</button>
                    <button class="btn-sm btn-purp" onclick="openFacModal('math')">+ Recommend</button>
                </td>
            </tr>
        </tbody>
    </table>
</div>

<div id="overlay" class="hidden">
    <div class="modal">
        <h3>Recommend Faculty</h3>
        <div id="facList"></div>
        <button onclick="document.getElementById('overlay').classList.add('hidden')" style="width:100%; margin-top:10px;">Cancel</button>
    </div>
</div>

<script>
    const firebaseConfig = {
      apiKey: "AIzaSyBBZ5Yvd7XH4lymNq2vIp-cwxPba55upWg",
      authDomain: "student-library-4a4e7.firebaseapp.com",
      projectId: "student-library-4a4e7",
      storageBucket: "student-library-4a4e7.firebasestorage.app",
      messagingSenderId: "827419448917",
      appId: "1:827419448917:web:4b0d1084e6f1fe1b2566dc"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // AUTO-ROTATE LOGIC
    async function markAuto(bookId, category, limit) {
        const snap = await db.collection("library_settings")
                             .where(category, "==", true)
                             .orderBy("updatedAt", "asc")
                             .get();

        // If limit reached, remove the oldest one
        if (snap.size >= limit) {
            const oldestId = snap.docs[0].id;
            await db.collection("library_settings").doc(oldestId).update({ [category]: false });
        }

        // Add new one
        await db.collection("library_settings").doc(bookId).set({
            [category]: true,
            updatedAt: new Date().toISOString()
        }, { merge: true });

        alert(`${bookId} added to ${category}. Oldest removed if over ${limit}.`);
    }

    async function unmark(bookId, category) {
        await db.collection("library_settings").doc(bookId).update({ [category]: false });
        alert("Removed from " + category);
    }

    let currentBook = "";
    async function openFacModal(bookId) {
        currentBook = bookId;
        document.getElementById('overlay').classList.remove('hidden');
        const snap = await db.collection("users").where("position", "==", "faculty").get();
        const list = document.getElementById('facList');
        list.innerHTML = "";
        snap.forEach(doc => {
            const f = doc.data();
            list.innerHTML += `<div onclick="assignFac('${f.uid}', '${f.fullName}')" style="padding:10px; cursor:pointer; border-bottom:1px solid #eee;">${f.fullName}</div>`;
        });
    }

    async function assignFac(uid, name) {
        // Faculty Recommendations are UNLIMITED
        await db.collection("recommendations").add({
            facultyId: uid,
            facultyName: name,
            bookId: currentBook,
            timestamp: new Date().toISOString()
        });
        alert("Recommended by " + name);
        document.getElementById('overlay').classList.add('hidden');
    }
</script>
</body>
</html>
