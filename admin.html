<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Library Admin - Promotion Control</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root { --blue: #3b82f6; --bg: #f8fafc; }
        body { font-family: 'Poppins', sans-serif; background: var(--bg); padding: 20px; color: #1e293b; }
        .card { background: white; border-radius: 20px; padding: 25px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); margin-bottom: 25px; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { text-align: left; padding: 12px; border-bottom: 1px solid #f1f5f9; font-size: 13px; }
        .btn-sm { padding: 6px 10px; border-radius: 8px; border: none; font-size: 11px; cursor: pointer; font-weight: 600; margin: 2px; }
    </style>
</head>
<body>

    <div class="card">
        <h2>ðŸ“‚ Global PDF Inventory</h2>
        <p style="font-size:11px; color:#64748b;">Recent Limit: 5 | Trending Limit: 15</p>
        <table>
            <thead><tr><th>PDF File</th><th>Status</th><th>Promotion Manager</th></tr></thead>
            <tbody id="inventory-list"></tbody>
        </table>
    </div>

<script>
    const db = firebase.firestore();

    // AUTO-MANAGE PROMOTIONS
    async function updatePromo(id, type, limit) {
        const snap = await db.collection("library_settings")
                           .where(type, "==", true)
                           .orderBy("updatedAt", "asc")
                           .get();
        
        if (!snap.empty && snap.size >= limit) {
            const oldestDoc = snap.docs[0];
            await db.collection("library_settings").doc(oldestDoc.id).update({ [type]: false });
        }
        
        await db.collection("library_settings").doc(id).update({ 
            [type]: true, 
            updatedAt: new Date().toISOString() 
        });
    }

    db.collection("library_settings").onSnapshot(snap => {
        const list = document.getElementById('inventory-list'); list.innerHTML = "";
        snap.forEach(doc => {
            const b = doc.data(); const id = doc.id;
            list.innerHTML += `<tr>
                <td><b>${b.title || id}</b></td>
                <td><small>${b.recent?'Recent':''} ${b.trending?'Trend':''}</small></td>
                <td>
                    <button class="btn-sm" style="background:#dcfce7" onclick="updatePromo('${id}', 'recent', 5)">+ Recent</button>
                    <button class="btn-sm" style="background:#fef9c3" onclick="updatePromo('${id}', 'trending', 15)">+ Trend</button>
                    <button class="btn-sm" onclick="db.collection('library_settings').doc('${id}').update({recent:false, trending:false})">Reset</button>
                </td>
            </tr>`;
        });
    });
</script>
</body>
</html>
