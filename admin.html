<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TheoLib Command Center</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root { --blue: #3b82f6; --orange: #f97316; --green: #10b981; --red: #ef4444; --bg: #0f172a; --card: #1e293b; --text: #f8fafc; --border: #334155; }
        body { font-family: 'Poppins', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; }
        .grid { display: grid; grid-template-columns: 1fr 1.2fr; gap: 20px; align-items: start; }
        .card { background: var(--card); border-radius: 15px; padding: 20px; border: 1px solid var(--border); margin-bottom: 20px; }
        h2 { color: var(--blue); margin-top: 0; font-size: 16px; display: flex; align-items: center; gap: 10px; }
        input, select, textarea { width: 100%; padding: 10px; margin-bottom: 10px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg); color: white; box-sizing: border-box; font-size: 13px; font-family: inherit; }
        button { width: 100%; padding: 12px; border-radius: 10px; border: none; cursor: pointer; font-weight: 600; transition: 0.2s; font-family: inherit; }
        .btn-blue { background: var(--blue); color: white; }
        .btn-red { background: var(--red); color: white; width: auto; padding: 4px 10px; font-size: 10px; border-radius: 5px; }
        .btn-action { background: #334155; color: white; padding: 4px 8px; width: auto; font-size: 10px; border-radius: 5px; border: 1px solid var(--border); }
        .btn-action.active { background: var(--green); border-color: var(--green); }
        .list-item { background: #161e2e; padding: 12px; border-radius: 10px; margin-bottom: 10px; border: 1px solid var(--border); font-size: 12px; }
        .scroll-area { max-height: 400px; overflow-y: auto; padding-right: 5px; }
        .hidden { display: none !important; }
        .breadcrumb { font-size: 12px; color: var(--blue); margin-bottom: 10px; cursor: pointer; }
        .multi-select-box { background: #0b1120; border: 1px solid var(--border); border-radius: 8px; padding: 10px; max-height: 100px; overflow-y: auto; margin-bottom: 10px; }
        .multi-option { display: flex; align-items: center; gap: 8px; font-size: 12px; margin-bottom: 5px; }
        .multi-option input { width: auto; margin: 0; }
    </style>
</head>
<body>

    <div id="auth-screen" style="position:fixed; inset:0; background:var(--bg); z-index:10000; display:flex; align-items:center; justify-content:center;">
        <div class="card" style="width:320px; text-align:center;">
            <h2 style="justify-content:center;">Command Center Login</h2>
            <select id="admin-role-select">
                <option value="super">Super Admin</option>
                <option value="college">College Admin</option>
            </select>
            <input type="text" id="admin-id" placeholder="Admin ID">
            <input type="password" id="admin-pass" placeholder="Password">
            <button class="btn-blue" onclick="checkAuth()">Login</button>
        </div>
    </div>

    <div id="main-portal">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h1 id="portal-title">TheoLib Command Center</h1>
            <button onclick="location.reload()" style="width:auto; padding:8px 15px; background:var(--card); color:white; border:1px solid var(--border);">üîÑ Sync System</button>
        </div>

        <div class="grid">
            <div>
                <div class="card" id="inventory-card">
                    <h2>üìö Inventory Management</h2>
                    <input type="text" id="b-title" placeholder="Book Title">
                    <input type="text" id="b-id" placeholder="Book ID (filename)">
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                        <select id="b-cat"><option value="Theology">Theology</option><option value="Acts">Acts of Apostles</option><option value="Ethics">Christian Ethics</option><option value="Other">Other</option></select>
                        <select id="b-lang"><option value="English">English</option><option value="Tamil">Tamil</option><option value="Malayalam">Malayalam</option></select>
                    </div>
                    
                    <label style="font-size: 11px; color: var(--blue);">Select Target Colleges:</label>
                    <div class="multi-select-box" id="b-colls-list">
                        </div>

                    <button class="btn-blue" onclick="addBook()">+ Add to Global Library</button>
                    <div class="scroll-area" id="book-list" style="margin-top:15px;"></div>
                </div>

                <div class="card" id="member-card">
                    <h2>üë• Member Management</h2>
                    <input type="text" id="m-name" placeholder="Full Name">
                    <select id="m-coll-select">
                        <option value="">Select College ID</option>
                    </select>
                    <div style="font-size: 10px; color: var(--orange); margin-bottom: 5px;">Or create new:</div>
                    <input type="text" id="m-coll-new" placeholder="New College ID">
                    
                    <input type="text" id="m-id" placeholder="User ID">
                    <input type="password" id="m-pass" placeholder="Password">
                    <select id="m-role">
                        <option value="student">Student</option>
                        <option value="faculty">Faculty</option>
                        <option value="college_admin">College Admin</option>
                    </select>
                    <button class="btn-blue" style="background:var(--green);" onclick="addMember()">+ Register Member</button>
                </div>
            </div>

            <div>
                <div class="card">
                    <h2>‚è±Ô∏è Attendance & Drill-Down</h2>
                    <div id="view-colleges"><div id="college-list-area" class="scroll-area"></div></div>
                    <div id="view-students" class="hidden"><div class="breadcrumb" onclick="showColleges()">‚Üê Back</div><div id="student-list-area" class="scroll-area"></div></div>
                    <div id="view-details" class="hidden">
                        <div class="breadcrumb" onclick="showStudents()">‚Üê Back</div>
                        <h3 id="det-name"></h3>
                        <div id="det-summary" style="display:flex; justify-content:space-between; background:#161e2e; padding:10px; border-radius:8px; font-size:12px;">
                            <div>Usage: <b id="sum-usage" style="color:var(--green)">0s</b></div>
                            <div>Read: <b id="sum-read" style="color:var(--blue)">0s</b></div>
                        </div>
                        <div class="scroll-area" id="det-logs" style="margin-top:10px;"></div>
                    </div>
                </div>

                <div class="card">
                    <h2>üì• Global Inbox</h2>
                    <div class="scroll-area" id="inbox-area"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize Firebase with your config
        const firebaseConfig = { apiKey: "AIzaSyBBZ5Yvd7XH4lymNq2vIp-cwxPba55upWg", authDomain: "theolib.in", projectId: "student-library-4a4e7", storageBucket: "student-library-4a4e7.firebasestorage.app", messagingSenderId: "827419448917", appId: "1:827419448917:web:4b0d1084e6f1fe1b2566dc" };
        firebase.initializeApp(firebaseConfig); const db = firebase.firestore();

        let loggedInRole = ""; 
        let loggedInCollege = "";

        // --- AUTH LOGIC (Super Admin vs College Admin) ---
        async function checkAuth() {
            const role = document.getElementById('admin-role-select').value;
            const id = document.getElementById('admin-id').value;
            const pass = document.getElementById('admin-pass').value;

            if(role === 'super' && id === 'admin' && pass === 'theo777') {
                loggedInRole = "super";
                setupDashboard();
            } else if (role === 'college') {
                const snap = await db.collection("users").where("studentId","==",id).where("password","==",pass).where("role","==","college_admin").get();
                if(!snap.empty) {
                    loggedInRole = "college";
                    loggedInCollege = snap.docs[0].data().collegeId;
                    setupDashboard();
                } else { alert("Invalid College Admin Credentials"); }
            } else { alert("Login Failed"); }
        }

        function setupDashboard() {
            document.getElementById('auth-screen').classList.add('hidden');
            if(loggedInRole === 'college') {
                document.getElementById('portal-title').innerText = "Admin Portal: " + loggedInCollege;
                document.getElementById('inventory-card').classList.add('hidden'); // College admins cannot add global books
                document.getElementById('m-coll-new').classList.add('hidden'); // Cannot create new colleges
                document.getElementById('m-coll-select').value = loggedInCollege;
                document.getElementById('m-coll-select').disabled = true;
            }
            loadColleges();
            loadBooks();
            loadInbox();
            loadAttendance();
        }

        // --- DYNAMIC DATA POPULATION ---
        function loadColleges() {
            db.collection("users").onSnapshot(snap => {
                const colleges = new Set();
                snap.forEach(doc => { if(doc.data().collegeId) colleges.add(doc.data().collegeId); });
                
                const select = document.getElementById('m-coll-select');
                const multiList = document.getElementById('b-colls-list');
                
                select.innerHTML = `<option value="">Select College ID</option>`;
                multiList.innerHTML = "";

                colleges.forEach(c => {
                    // For Member Management
                    select.innerHTML += `<option value="${c}">${c}</option>`;
                    // For Book Management Multi-Select
                    multiList.innerHTML += `
                        <div class="multi-option">
                            <input type="checkbox" name="target-colls" value="${c}">
                            <span>${c}</span>
                        </div>`;
                });
            });
        }

        // --- BOOK OPERATIONS ---
        async function addBook() {
            const title = document.getElementById('b-title').value, id = document.getElementById('b-id').value;
            const cat = document.getElementById('b-cat').value, lang = document.getElementById('b-lang').value;
            
            // Get selected checkboxes
            const selectedColls = Array.from(document.querySelectorAll('input[name="target-colls"]:checked')).map(cb => cb.value);

            if(!title || !id || selectedColls.length === 0) return alert("Fill all fields and select at least one college!");
            
            await db.collection("library_settings").doc(id).set({ 
                title, category: cat, language: lang, allowedColleges: selectedColls, recent: true 
            });
            alert("Book added and assigned!");
        }

        function loadBooks() {
            db.collection("library_settings").onSnapshot(snap => {
                const list = document.getElementById('book-list'); list.innerHTML = "";
                snap.forEach(doc => {
                    const b = doc.data();
                    list.innerHTML += `<div class="list-item"><b>${b.title}</b><br><small>Visible to: ${b.allowedColleges.join(', ')}</small></div>`;
                });
            });
        }

        // --- MEMBER OPERATIONS ---
        async function addMember() {
            const n = document.getElementById('m-name').value;
            const cSelect = document.getElementById('m-coll-select').value;
            const cNew = document.getElementById('m-coll-new').value.toUpperCase();
            const i = document.getElementById('m-id').value, p = document.getElementById('m-pass').value, r = document.getElementById('m-role').value;
            
            const finalCollege = cNew || cSelect;
            if(!finalCollege || !i || !p) return alert("Missing Member Info");

            await db.collection("users").add({ fullName: n, collegeId: finalCollege, studentId: i, password: p, role: r, lastActive: Date.now() });
            alert("Member Registered!");
            document.getElementById('m-name').value = ""; document.getElementById('m-id').value = "";
        }

        // --- ATTENDANCE & DRILL-DOWN (College Filtered) ---
        let allUsers = [];
        function loadAttendance() {
            db.collection("users").onSnapshot(snap => {
                allUsers = []; const colls = new Set();
                snap.forEach(doc => { 
                    const u = {id: doc.id, ...doc.data()}; 
                    if(loggedInRole === 'college' && u.collegeId !== loggedInCollege) return;
                    allUsers.push(u); colls.add(u.collegeId); 
                });
                const area = document.getElementById('college-list-area'); area.innerHTML = "";
                if(loggedInRole === 'super') {
                    Array.from(colls).forEach(c => area.innerHTML += `<div class="list-item" onclick="showStudents('${c}')">üìÅ College: ${c}</div>`);
                } else {
                    showStudents(loggedInCollege);
                }
            });
        }

        function showStudents(c) {
            document.getElementById('view-colleges').classList.add('hidden'); document.getElementById('view-students').classList.remove('hidden');
            const area = document.getElementById('student-list-area'); area.innerHTML = "";
            allUsers.filter(u => u.collegeId === c && u.role === 'student').forEach(u => area.innerHTML += `<div class="list-item" onclick="showDetails('${u.id}')">üë§ ${u.fullName}</div>`);
        }

        async function showDetails(uid) {
            const u = allUsers.find(x => x.id === uid);
            document.getElementById('view-students').classList.add('hidden'); document.getElementById('view-details').classList.remove('hidden');
            document.getElementById('det-name').innerText = u.fullName;
            db.collection("activity_logs").where("userId","==",uid).orderBy("startTime","desc").onSnapshot(snap => {
                const area = document.getElementById('det-logs'); area.innerHTML = "";
                let usage = 0; let read = 0;
                snap.forEach(doc => {
                    const l = doc.data(); const d = l.endTime ? Math.round((l.endTime - l.startTime)/1000) : 0;
                    if(l.type === "Usage") usage += d; if(l.type === "Full Read") read += d;
                    area.innerHTML += `<div style="font-size:10px; padding:5px; border-bottom:1px solid #334155;">${l.activity} (${d}s)</div>`;
                });
                document.getElementById('sum-usage').innerText = usage + "s"; document.getElementById('sum-read').innerText = read + "s";
            });
        }

        function showColleges() { document.getElementById('view-colleges').classList.remove('hidden'); document.getElementById('view-students').classList.add('hidden'); }
        function showStudents() { document.getElementById('view-students').classList.remove('hidden'); document.getElementById('view-details').classList.add('hidden'); }

        function loadInbox() {
            const query = loggedInRole === 'super' ? db.collection("admin_messages") : db.collection("admin_messages").where("college","==",loggedInCollege);
            query.orderBy("date","desc").onSnapshot(snap => {
                const area = document.getElementById('inbox-area'); area.innerHTML = "";
                snap.forEach(doc => {
                    const m = doc.data();
                    area.innerHTML += `<div class="inbox-msg"><b>${m.type}</b><br>${m.message || m.book}<br><small>From: ${m.user}</small></div>`;
                });
            });
        }
    </script>
</body>
</html>
